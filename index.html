<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel World - Draw on the Map</title>
    <!-- Leaflet CSS for Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* Global Styles */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
            background: #000;
            color: #fff;
            overflow: hidden;
        }

        /* Header */
        header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: #00ff00;
        }

        .tools {
            display: flex;
            gap: 10px;
        }

        .tool-btn {
            background: #333;
            color: #fff;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .tool-btn:hover, .tool-btn.active {
            background: #00ff00;
            color: #000;
        }

        .color-picker {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
        }

        /* Map Container */
        #map {
            height: 100vh;
            width: 100%;
        }

        /* Pixel Canvas Overlay */
        #pixelCanvas {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 1001;
            opacity: 0.8;
        }

        /* Instructions */
        .instructions {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
            z-index: 999;
        }

        /* Zoom Controls (Custom) */
        .zoom-controls {
            position: fixed;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 1002;
        }

        .zoom-btn {
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .zoom-btn:hover {
            background: #00ff00;
            color: #000;
        }

        /* Media Queries */
        @media (max-width: 768px) {
            .tools {
                flex-wrap: wrap;
            }
            .instructions {
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">Pixel World</div>
        <div class="tools">
            <button class="tool-btn active" id="brushBtn">Brush</button>
            <button class="tool-btn" id="eraserBtn">Eraser</button>
            <input type="color" class="color-picker" id="colorPicker" value="#00ff00">
            <button class="tool-btn" id="clearBtn">Clear</button>
            <button class="tool-btn" id="saveBtn">Save</button>
        </div>
    </header>

    <div id="map"></div>
    <canvas id="pixelCanvas"></canvas>

    <div class="zoom-controls">
        <button class="zoom-btn" id="zoomIn">+</button>
        <button class="zoom-btn" id="zoomOut">-</button>
    </div>

    <div class="instructions">
        Click and drag to draw pixels on the world map! Zoom with +/- or mouse wheel.
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize Map
        const map = L.map('map').setView([20, 0], 2); // Centered on world

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Pixel Canvas Setup
        const canvas = document.getElementById('pixelCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        // Pixel size (adjust for zoom)
        let pixelSize = 4;
        let isDrawing = false;
        let currentTool = 'brush';
        let currentColor = '#00ff00';

        // Resize Canvas on Window Resize
        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            redrawPixels(); // Redraw saved pixels
        });

        // Tool Selection
        document.getElementById('brushBtn').addEventListener('click', () => {
            currentTool = 'brush';
            setActiveTool('brushBtn');
        });

        document.getElementById('eraserBtn').addEventListener('click', () => {
            currentTool = 'eraser';
            setActiveTool('eraserBtn');
        });

        document.getElementById('colorPicker').addEventListener('change', (e) => {
            currentColor = e.target.value;
        });

        document.getElementById('clearBtn').addEventListener('click', () => {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            localStorage.removeItem('pixelData');
        });

        document.getElementById('saveBtn').addEventListener('click', () => {
            const data = canvas.toDataURL();
            const link = document.createElement('a');
            link.download = 'pixel-world.png';
            link.href = data;
            link.click();
        });

        function setActiveTool(btnId) {
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(btnId).classList.add('active');
        }

        // Drawing Logic
        canvas.addEventListener('mousedown', (e) => {
            isDrawing = true;
            draw(e);
        });

        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', () => { isDrawing = false; });
        canvas.addEventListener('mouseout', () => { isDrawing = false; });

        function draw(e) {
            if (!isDrawing) return;

            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            ctx.fillStyle = currentTool === 'eraser' ? '#000000' : currentColor; // Black for eraser (map background)
            ctx.fillRect(Math.floor(x / pixelSize) * pixelSize, Math.floor(y / pixelSize) * pixelSize, pixelSize, pixelSize);
        }

        // Zoom Controls
        document.getElementById('zoomIn').addEventListener('click', () => map.zoomIn());
        document.getElementById('zoomOut').addEventListener('click', () => map.zoomOut());

        map.on('zoomend', () => {
            // Adjust pixel size based on zoom (simple scaling)
            const zoom = map.getZoom();
            pixelSize = Math.max(1, 8 - zoom / 2);
            redrawPixels(); // Adjust pixels on zoom
        });

        // Mouse Wheel Zoom
        canvas.addEventListener('wheel', (e) => {
            e.preventDefault();
            if (e.deltaY < 0) map.zoomIn();
            else map.zoomOut();
        });

        // Load/Save Pixels (localStorage, keyed by map bounds for persistence)
        let pixelData = JSON.parse(localStorage.getItem('pixelData')) || {};

        function savePixels() {
            // Save relative to current view (simplified; in full, use lat/lng)
            const bounds = map.getBounds();
            pixelData[JSON.stringify(bounds)] = canvas.toDataURL();
            localStorage.setItem('pixelData', JSON.stringify(pixelData));
        }

        function redrawPixels() {
            // For now, clear and redraw from storage (expand later)
            if (Object.keys(pixelData).length > 0) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                // Load latest (simplified)
                const latest = Object.values(pixelData)[0];
                const img = new Image();
                img.onload = () => ctx.drawImage(img, 0, 0);
                img.src = latest;
            }
        }

        // Auto-save on draw end
        canvas.addEventListener('mouseup', savePixels);

        // Init: Load saved pixels
        redrawPixels();

        // Pointer events for canvas overlay
        canvas.style.pointerEvents = 'auto'; // Enable drawing on canvas
    </script>
</body>
</html>
